<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YFI Profile Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS COMPLETO */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #2c0439;
            padding: 40px 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: linear-gradient(135deg, #1a0226 0%, #2c0439 100%);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid rgba(191, 158, 75, 0.3);
            color: #f0f0f0;
        }
        
        h1, h2, h3 {
            color: #bf9e4b;
            text-align: center;
            margin-bottom: 20px;
        }
        
        h3 {
            font-size: 1.2em;
            margin-top: 20px;
        }
        
        .question-box {
            background: #1a0226;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-left: 5px solid #bf9e4b;
        }

        .question-text {
            font-size: 1.1em;
            margin-bottom: 15px;
            line-height: 1.6;
            color: #d0d0d0;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: #3c0651;
            color: #ffffff;
            font-family: 'Poppins', sans-serif;
            font-size: 1em;
            resize: vertical;
            margin-bottom: 15px;
        }

        .record-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px 25px;
            background: linear-gradient(90deg, #bf9e4b 0%, #ffd700 100%);
            color: #1a0226;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(191, 158, 75, 0.5);
            font-weight: 600;
        }

        .record-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(191, 158, 75, 0.7);
        }

        .record-button:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .nav-button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s ease;
            font-weight: 500;
        }

        .prev-button {
            background: #555;
            color: white;
        }

        .prev-button:hover:not(:disabled) {
            background: #777;
        }
        
        .next-button {
            background: #00b894;
            color: white;
        }
        
        .submit-button {
            background: #bf9e4b;
            color: #1a0226;
            font-weight: 700;
            width: 100%;
        }

        .submit-button:hover:not(:disabled) {
            background: #ffd700;
        }

        .hidden {
            display: none !important;
        }
        
        .audio-playback {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        audio {
            width: 100%;
            max-width: 300px;
            margin-right: 15px;
        }
        
        .status-message {
            margin-top: 10px;
            font-style: italic;
            color: #00b894;
        }

        .progress-bar-container {
            height: 10px;
            background: #444;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #bf9e4b 0%, #ffd700 100%);
            width: 0%;
            transition: width 0.4s ease-in-out;
        }
        
        .coach-login, .coach-panel {
            background: #3c0651;
            padding: 30px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .coach-login input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #555;
            background: #1a0226;
            color: white;
        }

        .coach-login button {
            background: #bf9e4b;
            color: #1a0226;
            font-weight: 600;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: 600;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .status-available {
            background: #00b894;
            color: white;
        }

        .status-occupied {
            background: #ff7675;
            color: white;
        }
        
        .control-buttons button {
            margin-right: 10px;
            margin-bottom: 10px;
            background: #4a4a4a;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        
        .control-buttons button:hover {
            background: #6a6a6a;
        }
        
        .control-buttons .logout-button {
            background: #d63031;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>YFI Profile Test</h1>
        <p style="text-align: center; margin-bottom: 30px; color: #aaa;">Prepara tu micr√≥fono y tu concentraci√≥n. Este test eval√∫a tu perfil ling√º√≠stico.</p>

        <div id="statusSection" class="coach-login">
            <h2>Panel de Control</h2>
            <div id="systemStatus">
                <span id="statusBadge" class="status-badge status-available">‚óè Dispon√≠vel</span>
            </div>
            <p id="testInstructions" style="color: #ccc; margin-bottom: 15px;">
                ¬°El sistema est√° libre! Puedes comenzar el test.
            </p>
            <button id="startButton" class="record-button" onclick="startTest()">Iniciar Test</button>
            
            <div id="coachLogin" class="hidden" style="margin-top: 20px;">
                <h3 style="margin-top: 0; text-align: left;">Acceso Coach</h3>
                <input type="password" id="coachPassword" placeholder="Contrase√±a de Coach">
                <button onclick="loginCoach()">Acceder</button>
            </div>
        </div>

        <div id="coachPanelSection" class="coach-panel hidden">
            <h3>Resultados Pendientes</h3>
            <p style="margin-bottom: 20px;">El test anterior fue completado pero los resultados no se han descargado. Por favor, procesa la informaci√≥n antes de liberar el sistema.</p>
            <div class="control-buttons">
                <button onclick="downloadResults()">Descargar Resultados</button>
                <button class="logout-button" onclick="clearAndRelease()">Limpiar y Liberar</button>
            </div>
        </div>

        <div id="questionSection" class="hidden">
            <h2 id="stepTitle">Paso 1 de 6</h2>
            <div id="progressBarContainer" class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>

            <div class="question-box">
                <div class="question-text" id="currentQuestionText"></div>
                
                <textarea id="textResponse" placeholder="Escribe tu respuesta aqu√≠..."></textarea>
                
                <div id="audioControls" class="hidden">
                    <button id="recordButton" class="record-button" onclick="toggleRecording()">
                        <span id="recordText">üéôÔ∏è Grabar Respuesta</span>
                    </button>
                    <p id="recordingStatus" class="status-message hidden">Grabando... (Click para detener)</p>
                    
                    <div id="playbackSection" class="audio-playback hidden">
                        <audio id="audioPlayback" controls></audio>
                        <button class="nav-button" onclick="discardRecording()">X</button>
                    </div>
                </div>
            </div>

            <div class="navigation-buttons">
                <button id="prevButton" class="nav-button prev-button" onclick="prevStep()" disabled>Anterior</button>
                <button id="nextButton" class="nav-button next-button" onclick="nextStep()">Siguiente</button>
                <button id="submitButton" class="nav-button submit-button hidden" onclick="submitTest()">Enviar Test</button>
            </div>
        </div>

        <div id="successScreen" class="coach-panel hidden">
            <h2>¬°Test Completado!</h2>
            <p style="text-align: center; color: #00b894; font-size: 1.1em;">Gracias por completar tu perfil. Tus resultados se est√°n procesando.</p>
            <p style="text-align: center; margin-top: 20px;">Por favor, contacta a tu coach para la siguiente etapa.</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script>
        // 1. CONFIGURACI√ìN Y CONEXI√ìN A FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCpx81xNSOOQTm_XiwwB452gqQegL6THVs", // Tu clave API
            authDomain: "tests-data-55907.firebaseapp.com",
            projectId: "tests-data-55907",
            storageBucket: "tests-data-55907.appspot.com", // CORREGIDO: Usar appspot.com
            messagingSenderId: "382761713502",
            appId: "1:382761713502:web:2c8e2b2580a24bb8"
        };
        
        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const storage = app.storage(); // Referencia clave a Storage para subir audios

        // 2. CONFIGURACI√ìN Y VARIABLES
        const COACH_PASSWORD = 'coach123'; // Tu contrase√±a de coach
        
        // üö® NUEVA URL DE FIREBASE CLOUD RUN (PROXY)
        // ESTA es la URL que resuelve el problema CORS y llama a tu GAS internamente.
        const FIREBASE_FUNCTION_URL = "https://gasproxytask-ypmt62jweq-uc.a.run.app"; 

        const questions = [
            // Paso 1: Escritura - 1
            {
                type: 'text',
                step: 1,
                textQuestion: "What do you do <strong class='highlight'>every day/strong>? Tell me about your <strong class='highlight'>daily routine.</strong>",
                audioQuestion: null,
                textPlain: "What do you do every day? Tell me about your daily routine.",
                audioPlain: null
            },
            // Paso 2: Grabaci√≥n - 1
            {
                type: 'audio',
                step: 2,
                textQuestion: null,
                audioQuestion: "What did you do <strong class='highlight'>yesterday</strong>? Describe your day from morning to evening.",
                textPlain: null,
                audioPlain: "What did you do yesterday? Describe your day from morning to evening."
            },
            // Paso 3: Escritura - 2
            {
                type: 'text',
                step: 3,
                textQuestion: "Can you describe a <strong class='highlight'>challenging situation</strong> you faced at school/work or in your personal life?",
                audioQuestion: null,
                textPlain: "Can you describe a challenging situation you faced at school/work or in your personal life?",
                audioPlain: null
            },
            // Paso 4: Grabaci√≥n - 2
            {
                type: 'audio',
                step: 4,
                textQuestion: null,
                audioQuestion: "Tell me about your <strong class='highlight'>future plans</strong>. Where do you see yourself in 5 years? Describe your goals.",
                textPlain: null,
                audioPlain: "Tell me about your future plans. Where do you see yourself in 5 years? Describe your goals."
            },
            // Paso 5: Escritura - 3
            {
                type: 'text',
                step: 5,
                textQuestion: "If you could change one <strong class='highlight'>global problem</strong>, what would it be and why?",
                audioQuestion: null,
                textPlain: "If you could change one global problem, what would it be and why?",
                audioPlain: null
            },
            // Paso 6: Grabaci√≥n - 3 (Env√≠o)
            {
                type: 'audio',
                step: 6,
                textQuestion: null,
                audioQuestion: "Describe a <strong class='highlight'>recent trip</strong> or experience you had. What did you learn?",
                textPlain: null,
                audioPlain: "Describe a recent trip or experience you had. What did you learn?"
            }
        ];

        let currentStep = 0;
        let responses = {
            text1: '', text2: '', text3: '',
            audio1: null, audio2: null, audio3: null
        };
        let recorder = null;
        let audioBlob = null;
        let audioUrl = null;
        let audioStream = null;

        // --- FUNCIONES DE CONTROL DE ESTADO ---
        
        function checkSystemStatus() {
            const results = sessionStorage.getItem('testResults');
            const statusBadge = document.getElementById('statusBadge');
            const startButton = document.getElementById('startButton');
            const coachLogin = document.getElementById('coachLogin');
            const testInstructions = document.getElementById('testInstructions');
            const coachPanelSection = document.getElementById('coachPanelSection');

            if (results) {
                // Sistema Ocupado: Hay resultados pendientes
                statusBadge.textContent = '‚óè Ocupado';
                statusBadge.className = 'status-badge status-occupied';
                startButton.classList.add('hidden');
                coachLogin.classList.remove('hidden');
                testInstructions.textContent = 'El sistema est√° ocupado. Accede como Coach para descargar o liberar los resultados.';
                coachPanelSection.classList.remove('hidden'); // Mostrar panel para descargar
            } else {
                // Sistema Disponible: Listo para empezar
                statusBadge.textContent = '‚óè Dispon√≠vel';
                statusBadge.className = 'status-badge status-available';
                startButton.classList.remove('hidden');
                coachLogin.classList.add('hidden');
                testInstructions.textContent = '¬°El sistema est√° libre! Puedes comenzar el test.';
                coachPanelSection.classList.add('hidden'); // Ocultar panel de coach
            }
        }
        
        function loginCoach() {
            const password = document.getElementById('coachPassword').value;
            if (password === COACH_PASSWORD) {
                document.getElementById('coachLogin').classList.add('hidden');
                document.getElementById('coachPanelSection').classList.remove('hidden');
                alert('Acceso de Coach exitoso.');
            } else {
                alert('Contrase√±a incorrecta.');
            }
        }

        // --- FUNCIONES DE NAVEGACI√ìN Y VISTA ---
        
        function startTest() {
            if (sessionStorage.getItem('testResults')) {
                alert('El sistema est√° ocupado. Un Coach debe liberar los resultados anteriores.');
                return;
            }
            
            document.getElementById('statusSection').classList.add('hidden');
            document.getElementById('questionSection').classList.remove('hidden');
            currentStep = 1;
            loadStep(currentStep);
        }

        function loadStep(step) {
            const q = questions.find(q => q.step === step);
            if (!q) return;

            // Guardar respuesta del paso anterior antes de cargar el nuevo
            saveCurrentResponse(); 

            // Actualizar vista
            document.getElementById('stepTitle').textContent = `Paso ${step} de ${questions.length}`;
            updateProgressBar();
            
            // Ocultar todos los modos
            document.getElementById('textResponse').classList.add('hidden');
            document.getElementById('audioControls').classList.add('hidden');
            document.getElementById('submitButton').classList.add('hidden');

            // Cargar contenido y controles
            document.getElementById('currentQuestionText').innerHTML = q.textQuestion || q.audioQuestion;

            if (q.type === 'text') {
                // Modo Escritura
                document.getElementById('textResponse').classList.remove('hidden');
                const responseKey = `text${Math.ceil(step / 2)}`;
                document.getElementById('textResponse').value = responses[responseKey] || '';
            } else if (q.type === 'audio') {
                // Modo Grabaci√≥n
                document.getElementById('audioControls').classList.remove('hidden');
                const responseKey = `audio${step / 2}`;
                
                // Mostrar controles de reproducci√≥n si hay un blob guardado
                if (responses[responseKey]) {
                    showPlaybackControls(responses[responseKey]);
                } else {
                    hidePlaybackControls();
                }
            }

            // L√≥gica de botones de navegaci√≥n
            document.getElementById('prevButton').disabled = step <= 1;
            const nextButton = document.getElementById('nextButton');
            
            if (step === questions.length) {
                nextButton.classList.add('hidden');
                document.getElementById('submitButton').classList.remove('hidden');
            } else {
                nextButton.classList.remove('hidden');
                document.getElementById('submitButton').classList.add('hidden');
            }
            
            checkNextButtonValidity(q);
        }
        
        function saveCurrentResponse() {
            const prevQ = questions.find(q => q.step === currentStep);
            if (!prevQ) return;
            
            if (prevQ.type === 'text') {
                const responseKey = `text${Math.ceil(currentStep / 2)}`;
                responses[responseKey] = document.getElementById('textResponse').value.trim();
            } else if (prevQ.type === 'audio') {
                 // responses[audioX] ya tiene el blob si se grab√≥
            }
        }
        
        function nextStep() {
            saveCurrentResponse(); // Guardar el paso actual
            
            // Validar si la respuesta del paso actual est√° completa
            const q = questions.find(q => q.step === currentStep);
            if (q.type === 'text' && responses[`text${Math.ceil(currentStep / 2)}`] === '') {
                alert('Por favor, completa la respuesta escrita antes de continuar.');
                return;
            }
            const audioKey = `audio${currentStep / 2}`;
            if (q.type === 'audio' && !responses[audioKey]) {
                alert('Por favor, graba tu respuesta de audio antes de continuar.');
                return;
            }
            
            if (currentStep < questions.length) {
                currentStep++;
                loadStep(currentStep);
            }
        }

        function prevStep() {
            saveCurrentResponse(); // Guardar el paso actual
            if (currentStep > 1) {
                currentStep--;
                loadStep(currentStep);
            }
        }

        function checkNextButtonValidity(q) {
            // L√≥gica de validaci√≥n del bot√≥n "Siguiente"
        }

        function updateProgressBar() {
            const progress = (currentStep / questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }


        // --- FUNCIONES DE GRABACI√ìN ---
        
        function showPlaybackControls(blob) {
            const url = URL.createObjectURL(blob);
            document.getElementById('audioPlayback').src = url;
            document.getElementById('playbackSection').classList.remove('hidden');
            document.getElementById('recordButton').disabled = false;
            document.getElementById('recordText').textContent = 'üéôÔ∏è Volver a Grabar';
        }
        
        function hidePlaybackControls() {
            document.getElementById('playbackSection').classList.add('hidden');
            document.getElementById('audioPlayback').src = '';
            document.getElementById('recordText').textContent = 'üéôÔ∏è Grabar Respuesta';
            
            const audioKey = `audio${currentStep / 2}`;
            responses[audioKey] = null; // Borrar el blob guardado
        }
        
        function discardRecording() {
            audioBlob = null;
            hidePlaybackControls();
        }

        async function toggleRecording() {
            if (recorder && recorder.state === 'recording') {
                // DETENER GRABACI√ìN
                recorder.stop();
                document.getElementById('recordingStatus').classList.add('hidden');
                document.getElementById('recordButton').disabled = true; // Deshabilitar mientras se procesa
            } else {
                // INICIAR GRABACI√ìN
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(audioStream);
                const audioChunks = [];

                recorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                recorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    const audioKey = `audio${currentStep / 2}`;
                    responses[audioKey] = audioBlob; // Guardar el blob en las respuestas
                    
                    showPlaybackControls(audioBlob);
                    audioStream.getTracks().forEach(track => track.stop()); // Detener la c√°mara/micr√≥fono
                };

                recorder.start();
                document.getElementById('recordingStatus').classList.remove('hidden');
                document.getElementById('recordText').textContent = '‚èπÔ∏è Detener Grabaci√≥n';
            }
        }

        // --- FUNCI√ìN DE ENV√çO FINAL ---

        async function submitTest() {
            saveCurrentResponse(); // Guardar la respuesta final

            // Validar la √∫ltima respuesta
            const q = questions.find(q => q.step === currentStep);
            const audioKey = `audio${currentStep / 2}`;
            if (!responses[audioKey]) {
                alert('Por favor, graba tu respuesta final antes de enviar.');
                return;
            }
            
            document.getElementById('submitButton').disabled = true;
            document.getElementById('submitButton').textContent = 'Enviando...';

            const email = prompt("Por favor, introduce tu email (para seguimiento de resultados):");
            if (!email) {
                alert("Email es requerido para enviar el test.");
                document.getElementById('submitButton').disabled = false;
                document.getElementById('submitButton').textContent = 'Enviar Test';
                return;
            }

            // 1. Preparar datos y promesas de subida
            const textOnlyData = {
                email: email,
                timestamp: new Date().toISOString(),
                urls: {} // Aqu√≠ guardaremos las URLs de Firebase Storage
            };

            const uploadPromises = [];
            let audioCount = 0;

            for (let i = 1; i <= 3; i++) {
                // A. Respuestas de Texto
                textOnlyData[`text${i}`] = responses[`text${i}`] || 'No respondido';

                // B. Subida de Audios
                const blob = responses[`audio${i}`];
                if (blob) {
                    audioCount++;
                    const audioFileName = `${email.split('@')[0]}_audio${i}_${Date.now()}.webm`;
                    const storageRef = storage.ref().child(`yfi_tests/${audioFileName}`);
                    
                    const uploadTask = storageRef.put(blob);
                    
                    // A√±adir promesa para obtener la URL de descarga
                    const urlPromise = new Promise((resolve, reject) => {
                        uploadTask.on('state_changed', 
                            (snapshot) => {
                                // Puedes implementar un feedback de progreso aqu√≠ si es necesario
                                console.log(`Progreso de Audio ${i}:`, (snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                            }, 
                            (error) => {
                                reject(error);
                            }, 
                            () => {
                                // √âxito: obtener URL de descarga
                                storageRef.getDownloadURL().then(url => {
                                    textOnlyData.urls[`audio${i}_url`] = url;
                                    resolve();
                                }).catch(reject);
                            }
                        );
                    });
                    uploadPromises.push(urlPromise);
                }
            }

            // 2. Ejecutar todas las subidas y la llamada al back-end
            Promise.all(uploadPromises)
                .then(() => {
                    // √âXITO: Todos los audios subieron correctamente y las URLs est√°n en textOnlyData
                    sessionStorage.setItem('testResults', JSON.stringify(textOnlyData)); 

                    // üö® NUEVO PASO: ENV√çA LOS RESULTADOS AL BACKEND PERMANENTE (V√çA FIREBASE PROXY)
                    return fetch(FIREBASE_FUNCTION_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        // Enviamos todos los datos (incluyendo las URLs de Storage)
                        body: JSON.stringify({ 
                            action: 'saveTestResults', 
                            data: textOnlyData 
                        }), 
                    })
                    .then(response => {
                        if (!response.ok) {
                             throw new Error('El backend (GAS) respondi√≥ con un error: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(backendData => {
                        console.log("Datos enviados al backend (GAS) con √©xito:", backendData);
                    })
                    .catch(error => {
                        console.error("Fallo al enviar datos al GAS/Airtable:", error);
                        alert("‚ö†Ô∏è Alerta: Los audios se subieron, pero fall√≥ el env√≠o de los datos de texto al sistema de Airtable. Revisa la consola.");
                    });
                })
                .then(() => {
                    // Este es el .then() que maneja la finalizaci√≥n de la subida Y la llamada a fetch
                    document.getElementById('questionSection').classList.add('hidden');
                    document.getElementById('progressBar').classList.add('hidden');
                    document.getElementById('successScreen').classList.remove('hidden');
                    
                    const statusBadge = document.getElementById('statusBadge');
                    statusBadge.textContent = '‚óè Ocupado';
                    statusBadge.className = 'status-badge status-occupied';
                    
                    alert("¬°Test enviado con √©xito! Respuestas y audios guardados.");
                })
                .catch(error => {
                    // Manejo de errores si fall√≥ la subida de audios o la conexi√≥n inicial
                    console.error("Error cr√≠tico durante la subida de audios o conexi√≥n al proxy:", error);
                    alert("üö´ Error cr√≠tico. No se pudo completar el test. Detalles en la consola.");
                })
                .finally(() => {
                    document.getElementById('submitButton').disabled = false;
                    document.getElementById('submitButton').textContent = 'Enviar Test';
                });
        }


        // --- FUNCIONES DE COACH ---
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', checkSystemStatus);


        function downloadResults() {
            const results = sessionStorage.getItem('testResults');
            if (!results) {
                alert('No hay resultados pendientes para descargar.');
                return;
            }

            const data = JSON.parse(results);
            let textContent = `--- YFI PROFILE TEST RESULTS ---\n`;
            textContent += `Email: ${data.email}\n`;
            textContent += `Timestamp: ${data.timestamp}\n\n`;

            textContent += `--- RESPUESTAS ESCRITAS ---\n`;
            textContent += `1. ${data.text1}\n`;
            textContent += `3. ${data.text2}\n`;
            textContent += `5. ${data.text3}\n\n`;
            
            textContent += `--- URLs DE AUDIO ---\n`;
            textContent += `Audio 2 URL: ${data.urls.audio2_url || 'No grabado'}\n`;
            textContent += `Audio 4 URL: ${data.urls.audio4_url || 'No grabado'}\n`;
            textContent += `Audio 6 URL: ${data.urls.audio6_url || 'No grabado'}\n\n`;

            const blob = new Blob([textContent], { type: 'text/plain' });
            const textUrl = URL.createObjectURL(blob);
            
            const textLink = document.createElement('a');
            textLink.href = textUrl;
            textLink.download = `YFI_Test_Results_${data.email.split('@')[0]}_${new Date().toLocaleDateString('es-AR').replace(/\//g, '-')}.txt`;
            textLink.style.display = 'none';
            document.body.appendChild(textLink);
            textLink.click();
            URL.revokeObjectURL(textUrl);
            
            let message = 'Arquivos baixados com sucesso!\n\n‚úì Respostas escritas (TXT) com URLs de √°udio\n';
            message += '\nüìä Analise os resultados para criar o perfil do aluno.';
            
            alert(message);
        }

        // Limpiar y liberar
        function clearAndRelease() {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja limpiar los resultados y liberar el sistema?\n\nEsta acci√≥n no puede ser deshecha. Aseg√∫rate de haber descargado los resultados antes de continuar.')) {
                sessionStorage.removeItem('testResults');
                
                currentStep = 0;
                responses = {
                    text1: '', text2: '', text3: '',
                    audio1: null, audio2: null, audio3: null
                };
                
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = '‚óè Dispon√≠vel';
                statusBadge.className = 'status-badge status-available';
                
                alert('‚úì Sistema liberado con √©xito!\n\nEl pr√≥ximo alumno ya puede hacer el test.');
                
                logout();
            }
        }

        // Logout
        function logout() {
            document.getElementById('coachPanelSection').classList.add('hidden');
            checkSystemStatus();
        }
    </script>
</body>
</html>